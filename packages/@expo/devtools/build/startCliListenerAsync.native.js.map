{"version":3,"file":"startCliListenerAsync.native.js","sourceRoot":"","sources":["../src/startCliListenerAsync.native.ts"],"names":[],"mappings":"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","sourcesContent":["import Constants from 'expo-constants';\nimport { Platform } from 'react-native';\n\nimport { getDevToolsPluginClientAsync } from './DevToolsPluginClientFactory';\n\n/**\n * Starts a new imperative listener for cli plugins. This is an alternative to the useDevToolsPlugin\n * hook that is used with devtools. This function is used to avoid having the user to use the hook,\n * and to be able to imperatively communicate over the web socket connections with running apps.\n * We should not run these if we are in production - but we should run in development\n * and when in a development client built in release mode with EAS.\n * @returns\n */\nexport const startCliListenerAsync = async (pluginName: string) => {\n  // Only include this code if we are in a development environment.\n  if (process.env.NODE_ENV !== 'production') {\n    console.debug(\n      `[startCliListenerAsync] Starting CLI message listener for plugin ${pluginName}...`\n    );\n    let clientRef: Awaited<ReturnType<typeof getDevToolsPluginClientAsync>> | null = null;\n    const listenerRemovals: (() => void)[] = [];\n\n    const getDeviceName = () => {\n      const name = Constants.deviceName ?? 'Unknown device';\n      return Platform.OS === 'android' ? name + ' - ' + Platform.Version : name;\n    };\n\n    const client = await getDevToolsPluginClientAsync(pluginName);\n    if (clientRef != null) {\n      // Clean up the previous client if it exists\n      listenerRemovals.forEach((remove) => remove());\n      listenerRemovals.length = 0;\n    }\n    clientRef = client;\n\n    // Ensure the module is properly cleaned up on hot reloads\n    const m = module;\n    if ('hot' in m && m.hot) {\n      const hot = m.hot as object;\n      if ('dispose' in hot && hot.dispose && hot.dispose instanceof Function) {\n        hot.dispose(() => {\n          listenerRemovals.forEach((remove) => remove());\n          listenerRemovals.length = 0;\n        });\n      }\n    }\n\n    // Create the addMessageListener function for the plugin\n    const addMessageListener = <P extends Record<string, string>>(\n      eventName: string,\n      callback: (arg: { params: P; sendResponseAsync: (message: string) => Promise<void> }) => void\n    ) => {\n      listenerRemovals.push(\n        client.addMessageListener(eventName, async (params) => {\n          // Create response message function\n          const sendResponseAsync = async (message: string) => {\n            await sendMessageAsync(eventName + '_response', message);\n          };\n          callback({ params, sendResponseAsync });\n        }).remove\n      );\n    };\n\n    // Create the sendMessageAsync function for the plugin\n    const sendMessageAsync = async (eventName: string, message: string) => {\n      await client.sendMessage(eventName, {\n        message,\n        deviceName: getDeviceName(),\n        applicationId:\n          Platform.OS === 'ios'\n            ? Constants.expoConfig?.ios?.bundleIdentifier\n            : Constants.expoConfig?.android?.package,\n      });\n    };\n\n    return { addMessageListener, sendMessageAsync };\n  } else {\n    console.debug(`Skipping starting startDevToolsPluginListenerAsync for plugin ${pluginName}...`);\n    const addMessageListener = <P extends Record<string, string>>(\n      _e: string,\n      _c: (arg: { params: P; sendResponseAsync: (message: string) => Promise<void> }) => void\n    ) => {};\n\n    // Create the sendMessageAsync function for the plugin\n    const sendMessageAsync = async (_e: string, _m: string) => {};\n    return { addMessageListener, sendMessageAsync };\n  }\n};\n"]}