{"version":3,"file":"NativeStackRouter.js","sourceRoot":"","sources":["../../src/native-stack-view/NativeStackRouter.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  type ParamListBase,\n  type PartialState,\n  type Router,\n  StackActions,\n  type StackNavigationState,\n} from '@react-navigation/native';\nimport { nanoid } from 'nanoid/non-secure';\n\nexport type NativeStackState = StackNavigationState<ParamListBase> & {\n  poppedRoutes: Set<string>;\n};\n\ntype NativeStackAction = {\n  type: string;\n  payload?: object;\n  source?: string;\n  target?: string;\n};\n\nfunction createParams(\n  routeParamList: ParamListBase,\n  name: string,\n  params?: object\n): object | undefined {\n  const defaults = routeParamList[name];\n  return defaults ? { ...defaults, ...params } : params;\n}\n\nfunction createRoute(routeParamList: ParamListBase, name: string, params?: object) {\n  return {\n    key: `${name}-${nanoid()}`,\n    name,\n    params: createParams(routeParamList, name, params),\n  };\n}\n\nexport type NativeStackRouterOptions = {\n  initialRouteName?: string;\n};\n\nexport function NativeStackRouter({\n  initialRouteName,\n}: NativeStackRouterOptions): Router<NativeStackState, NativeStackAction> {\n  function pickInitialRouteName(routeNames: string[]) {\n    return initialRouteName && routeNames.includes(initialRouteName)\n      ? initialRouteName\n      : routeNames[0];\n  }\n\n  return {\n    type: 'stack',\n\n    getInitialState({ routeNames, routeParamList }) {\n      console.log('getInitialState', { routeNames, initialRouteName });\n      const name = pickInitialRouteName(routeNames);\n\n      return {\n        stale: false as const,\n        type: 'stack' as const,\n        key: `stack-${nanoid()}`,\n        index: 0,\n        routeNames,\n        routes: [createRoute(routeParamList, name)],\n        preloadedRoutes: [],\n        poppedRoutes: new Set<string>(),\n      };\n    },\n\n    getRehydratedState(partialState, { routeNames, routeParamList }) {\n      if (partialState.stale === false) {\n        return partialState as NativeStackState;\n      }\n      console.log('getRehydratedState', { partialState, routeNames, initialRouteName });\n\n      let routes = (partialState.routes ?? [])\n        .filter((r) => routeNames.includes(r.name))\n        .map((r) => ({\n          ...r,\n          key: r.key || `${r.name}-${nanoid()}`,\n          params: createParams(routeParamList, r.name, r.params as object | undefined),\n        }));\n\n      if (routes.length === 0) {\n        const name = pickInitialRouteName(routeNames);\n        routes = [createRoute(routeParamList, name)];\n      }\n\n      return {\n        stale: false as const,\n        type: 'stack' as const,\n        key: `stack-${nanoid()}`,\n        index: partialState.index ?? routes.length - 1,\n        routeNames,\n        routes,\n        preloadedRoutes: [],\n        poppedRoutes: new Set<string>(),\n      };\n    },\n\n    getStateForRouteNamesChange(state, { routeNames, routeParamList, routeKeyChanges }) {\n      const routes = state.routes.filter(\n        (r) => routeNames.includes(r.name) && !routeKeyChanges.includes(r.name)\n      );\n\n      if (routes.length === 0) {\n        const name = pickInitialRouteName(routeNames);\n        return {\n          ...state,\n          routeNames,\n          index: 0,\n          routes: [createRoute(routeParamList, name)],\n        };\n      }\n\n      return {\n        ...state,\n        routeNames,\n        index: Math.min(state.index, routes.length - 1),\n        routes,\n      };\n    },\n\n    getStateForRouteFocus(state, key) {\n      const index = state.routes.findIndex((r) => r.key === key);\n      if (index === -1 || index === state.index) {\n        return state;\n      }\n      return {\n        ...state,\n        index,\n        routes: state.routes.slice(0, index + 1),\n      };\n    },\n\n    getStateForAction(state, action, options) {\n      const { routeNames, routeParamList } = options;\n      const payload = action.payload as Record<string, any> | undefined;\n      console.log('getStateForAction', action.type);\n\n      switch (action.type) {\n        case 'PUSH': {\n          const name: string = payload?.name;\n          const params: object | undefined = payload?.params;\n          if (!routeNames.includes(name)) {\n            return null;\n          }\n          const route = createRoute(routeParamList, name, params);\n          const routes = [...state.routes, route];\n          return {\n            ...state,\n            index: routes.length - 1,\n            routes,\n          };\n        }\n\n        case 'NAVIGATE': {\n          return this.getStateForAction(\n            state,\n            {\n              type: 'PUSH',\n              payload: action.payload,\n              source: action.source,\n              target: action.target,\n            },\n            options\n          );\n        }\n\n        case 'POP': {\n          const count = Math.max(payload?.count ?? 1, 1);\n          const currentIndex = action.source\n            ? state.routes.findIndex((r) => r.key === action.source)\n            : state.index;\n\n          if (currentIndex <= 0) {\n            return null;\n          }\n\n          // Keep at least 1 route from the bottom, remove `count` from below currentIndex\n          const keepCount = Math.max(currentIndex - count + 1, 1);\n          const poppedRoutes = state.routes.slice(keepCount, currentIndex + 1).map(r => r.key);\n\n          // The route removal will happen in the next action (when the screen is dismissed on native side)\n          return {\n            ...state,\n            index: keepCount - 1,\n            poppedRoutes: new Set([...state.poppedRoutes, ...poppedRoutes]),\n          };\n        }\n\n        case 'POP_TO_TOP': {\n          return this.getStateForAction(\n            state,\n            { type: 'POP', payload: { count: state.routes.length - 1 } },\n            options\n          );\n        }\n\n        case 'REPLACE': {\n          const name: string = payload?.name;\n          const params: object | undefined = payload?.params;\n          if (!routeNames.includes(name)) {\n            return null;\n          }\n\n          const currentIndex =\n            action.target === state.key && action.source\n              ? state.routes.findIndex((r) => r.key === action.source)\n              : state.index;\n\n          if (currentIndex !== state.index) {\n            throw new Error(\n              'REPLACE is only supported for the focused route in Native Stack Router.'\n            );\n          }\n\n          if (currentIndex === -1) {\n            return null;\n          }\n\n          const route = createRoute(routeParamList, name, params);\n          const routes = [...state.routes.slice(-1), route];\n          return { ...state, routes };\n        }\n\n        case 'GO_BACK': {\n          return this.getStateForAction(\n            state,\n            {\n              type: 'POP',\n              payload: { count: 1 },\n              source: action.source,\n              target: action.target,\n            },\n            options\n          );\n        }\n\n        case 'SET_PARAMS': {\n          throw new Error('SET_PARAMS action is not supported yet');\n        }\n\n        case 'REPLACE_PARAMS': {\n          throw new Error('REPLACE_PARAMS action is not supported yet');\n        }\n\n        case 'RESET': {\n          const nextState = payload as\n            | PartialState<NativeStackState>\n            | NativeStackState\n            | undefined;\n\n          if (!nextState?.routes?.length) {\n            return null;\n          }\n\n          if (nextState.routes.some((r: { name: string }) => !routeNames.includes(r.name))) {\n            return null;\n          }\n\n          if (nextState.stale === false) {\n            return nextState as NativeStackState;\n          }\n\n          // Rehydrate partial state into a full state\n          return this.getRehydratedState(nextState, options);\n        }\n\n        default:\n          return null;\n      }\n    },\n\n    shouldActionChangeFocus(action) {\n      return action.type === 'NAVIGATE';\n    },\n\n    actionCreators: StackActions,\n  };\n}\n"]}