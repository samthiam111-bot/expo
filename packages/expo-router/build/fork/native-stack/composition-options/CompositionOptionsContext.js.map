{"version":3,"file":"CompositionOptionsContext.js","sourceRoot":"","sources":["../../../../src/fork/native-stack/composition-options/CompositionOptionsContext.tsx"],"names":[],"mappings":"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","sourcesContent":["'use client';\n\nimport { useRoute } from '@react-navigation/native';\nimport type { NativeStackNavigationOptions } from '@react-navigation/native-stack';\nimport { createContext, use, useCallback, useMemo, useReducer } from 'react';\n\nimport type { CompositionContextValue, CompositionRegistry } from './types';\nimport { useSafeLayoutEffect } from '../../../views/useSafeLayoutEffect';\n\n/** @internal */\nexport const CompositionContext = createContext<CompositionContextValue | null>(null);\n\ntype RegistryAction =\n  | {\n      type: 'set';\n      routeKey: string;\n      options: Partial<NativeStackNavigationOptions>;\n    }\n  | { type: 'unset'; routeKey: string; options: Partial<NativeStackNavigationOptions> };\n\n/** @internal */\nexport function registryReducer(\n  state: CompositionRegistry,\n  action: RegistryAction\n): CompositionRegistry {\n  if (action.type === 'set') {\n    const { routeKey, options } = action;\n    if (state[routeKey]?.includes(options)) {\n      return state;\n    }\n    return { ...state, [routeKey]: [...(state[routeKey] ?? []), options] };\n  }\n\n  if (action.type === 'unset') {\n    const { routeKey, options } = action;\n    const existing = state[routeKey];\n    const filtered = existing?.filter((o) => o !== options);\n    if (!existing || filtered?.length === existing.length) {\n      return state;\n    }\n    if (filtered.length === 0) {\n      const { [routeKey]: _, ...newState } = state;\n      return newState;\n    }\n    return { ...state, [routeKey]: filtered };\n  }\n  return state;\n}\n\n/**\n * Provides the composition registry to descendant composition components.\n *\n * Uses useReducer with immutable object updates for React Compiler compatibility.\n * Each set/unset call produces a new object reference, which the compiler can\n * track as a reactive dependency.\n */\nexport function useCompositionRegistry() {\n  const [registry, dispatch] = useReducer(registryReducer, {} as CompositionRegistry);\n\n  const set = useCallback((routeKey: string, options: Partial<NativeStackNavigationOptions>) => {\n    dispatch({ type: 'set', routeKey, options });\n  }, []);\n\n  const unset = useCallback((routeKey: string, options: Partial<NativeStackNavigationOptions>) => {\n    dispatch({ type: 'unset', routeKey, options });\n  }, []);\n\n  const contextValue = useMemo(\n    () => ({ set, unset }) satisfies CompositionContextValue,\n    [set, unset]\n  );\n  return { registry, contextValue };\n}\n\n/**\n * Hook used by composition components to register their options in the composition registry.\n *\n * Registers options on mount/update via useSafeLayoutEffect, and unregisters on unmount.\n * Callers should memoize the options object to avoid unnecessary re-registrations.\n */\nexport function useCompositionOption(options: Partial<NativeStackNavigationOptions>) {\n  const context = use(CompositionContext);\n  if (!context) {\n    throw new Error(\n      'useCompositionOption must be used within a RouterCompositionOptionsProvider. This is likely a bug in Expo Router.'\n    );\n  }\n\n  const route = useRoute();\n  const { set, unset } = context;\n\n  useSafeLayoutEffect(() => {\n    set(route.key, options);\n    return () => {\n      unset(route.key, options);\n    };\n  }, [route.key, set, unset, options]);\n}\n"]}