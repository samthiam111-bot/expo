{"version":3,"file":"createNativeStackNavigator.js","sourceRoot":"","sources":["../../../src/fork/native-stack/createNativeStackNavigator.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  createNavigatorFactory,\n  type EventArg,\n  type NavigatorTypeBagBase,\n  type ParamListBase,\n  type StackActionHelpers,\n  StackActions,\n  type StackNavigationState,\n  StackRouter,\n  type StackRouterOptions,\n  type StaticConfig,\n  type TypedNavigator,\n  useNavigationBuilder,\n} from '@react-navigation/native';\nimport {\n  type NativeStackNavigationEventMap,\n  type NativeStackNavigationOptions,\n  type NativeStackNavigationProp,\n  NativeStackView,\n  type NativeStackNavigatorProps,\n} from '@react-navigation/native-stack';\nimport { isLiquidGlassAvailable } from 'expo-glass-effect';\nimport * as React from 'react';\n\nimport { CompositionContext, mergeOptions, useCompositionRegistry } from './composition-options';\nimport { DescriptorsContext } from './descriptors-context';\nimport { usePreviewTransition } from './usePreviewTransition';\nimport {\n  INTERNAL_EXPO_ROUTER_GESTURE_ENABLED_OPTION_NAME,\n  type InternalNavigationOptions,\n} from '../../navigationParams';\n\nconst GLASS = isLiquidGlassAvailable();\n\ntype NativeStackNavigationOptionsWithInternal = NativeStackNavigationOptions &\n  InternalNavigationOptions;\n\nfunction NativeStackNavigator({\n  id,\n  initialRouteName,\n  children,\n  layout,\n  screenListeners,\n  screenOptions,\n  screenLayout,\n  UNSTABLE_router,\n  ...rest\n}: NativeStackNavigatorProps) {\n  const { state, describe, descriptors, navigation, NavigationContent } = useNavigationBuilder<\n    StackNavigationState<ParamListBase>,\n    StackRouterOptions,\n    StackActionHelpers<ParamListBase>,\n    NativeStackNavigationOptionsWithInternal,\n    NativeStackNavigationEventMap\n  >(StackRouter, {\n    id,\n    initialRouteName,\n    children,\n    layout,\n    screenListeners,\n    screenOptions,\n    screenLayout,\n    UNSTABLE_router,\n  });\n\n  React.useEffect(\n    () =>\n      // @ts-expect-error: there may not be a tab navigator in parent\n      navigation?.addListener?.('tabPress', (e: any) => {\n        const isFocused = navigation.isFocused();\n\n        // Run the operation in the next frame so we're sure all listeners have been run\n        // This is necessary to know if preventDefault() has been called\n        requestAnimationFrame(() => {\n          if (state.index > 0 && isFocused && !(e as EventArg<'tabPress', true>).defaultPrevented) {\n            // When user taps on already focused tab and we're inside the tab,\n            // reset the stack to replicate native behaviour\n            // START FORK\n            // navigation.dispatch({\n            //   ...StackActions.popToTop(),\n            //   target: state.key,\n            // });\n            // The popToTop will be automatically triggered on native side for native tabs\n            if (e.data?.__internalTabsType !== 'native') {\n              navigation.dispatch({\n                ...StackActions.popToTop(),\n                target: state.key,\n              });\n            }\n            // END FORK\n          }\n        });\n      }),\n    [navigation, state.index, state.key]\n  );\n\n  // START FORK\n  const { computedState, computedDescriptors, navigationWrapper } = usePreviewTransition(\n    state,\n    navigation,\n    descriptors,\n    describe\n  );\n\n  // Map internal gesture option to React Navigation's gestureEnabled option\n  // This allows Expo Router to override gesture behavior without affecting user settings\n  const finalDescriptors = React.useMemo(() => {\n    let needsNewMap = false;\n    const result: typeof computedDescriptors = {};\n    for (const key of Object.keys(computedDescriptors)) {\n      const descriptor = computedDescriptors[key];\n      const options = descriptor.options as NativeStackNavigationOptionsWithInternal;\n      const internalGestureEnabled = options?.[INTERNAL_EXPO_ROUTER_GESTURE_ENABLED_OPTION_NAME];\n      const needsGestureFix = internalGestureEnabled !== undefined;\n      const needsGlassFix = GLASS && options?.presentation === 'formSheet';\n\n      if (needsGestureFix || needsGlassFix) {\n        needsNewMap = true;\n        const newOptions = { ...options };\n        if (needsGestureFix) {\n          newOptions.gestureEnabled = internalGestureEnabled;\n        }\n        if (needsGlassFix) {\n          newOptions.headerTransparent ??= true;\n          newOptions.contentStyle ??= { backgroundColor: 'transparent' };\n          newOptions.headerShadowVisible ??= false;\n          newOptions.headerLargeTitleShadowVisible ??= false;\n        }\n        result[key] = { ...descriptor, options: newOptions };\n      } else {\n        result[key] = descriptor;\n      }\n    }\n    return needsNewMap ? result : computedDescriptors;\n  }, [computedDescriptors]);\n  const { registry, contextValue } = useCompositionRegistry();\n\n  const mergedDescriptors = React.useMemo(\n    () => mergeOptions(finalDescriptors, registry, computedState),\n    [finalDescriptors, computedState, registry]\n  );\n  // END FORK\n\n  return (\n    // START FORK\n    <DescriptorsContext value={descriptors}>\n      {/* END FORK */}\n      <NavigationContent>\n        <CompositionContext value={contextValue}>\n          <NativeStackView\n            {...rest}\n            // START FORK\n            state={computedState}\n            navigation={navigationWrapper}\n            descriptors={mergedDescriptors}\n            // state={state}\n            // navigation={navigation}\n            // descriptors={descriptors}\n            // END FORK\n            describe={describe}\n          />\n        </CompositionContext>\n      </NavigationContent>\n      {/* START FORK */}\n    </DescriptorsContext>\n    // END FORK\n  );\n}\n\nexport function createNativeStackNavigator<\n  const ParamList extends ParamListBase,\n  const NavigatorID extends string | undefined = undefined,\n  const TypeBag extends NavigatorTypeBagBase = {\n    ParamList: ParamList;\n    NavigatorID: NavigatorID;\n    State: StackNavigationState<ParamList>;\n    ScreenOptions: NativeStackNavigationOptions;\n    EventMap: NativeStackNavigationEventMap;\n    NavigationList: {\n      [RouteName in keyof ParamList]: NativeStackNavigationProp<ParamList, RouteName, NavigatorID>;\n    };\n    Navigator: typeof NativeStackNavigator;\n  },\n  const Config extends StaticConfig<TypeBag> = StaticConfig<TypeBag>,\n>(config?: Config): TypedNavigator<TypeBag, Config> {\n  return createNavigatorFactory(NativeStackNavigator)(config);\n}\n"]}