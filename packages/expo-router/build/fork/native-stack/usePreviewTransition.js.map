{"version":3,"file":"usePreviewTransition.js","sourceRoot":"","sources":["../../../src/fork/native-stack/usePreviewTransition.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ParamListBase, StackNavigationState } from '@react-navigation/native';\nimport * as React from 'react';\n\nimport type { NativeStackDescriptor, NativeStackDescriptorMap } from './descriptors-context';\nimport { useLinkPreviewContext } from '../../link/preview/LinkPreviewContext';\n\n/** Mirrors the `describe` function returned by `useNavigationBuilder` */\ntype DescribeFn = (\n  route: StackNavigationState<ParamListBase>['preloadedRoutes'][number],\n  placeholder: boolean\n) => NativeStackDescriptor;\n\n/**\n * Manages the preview transition state for link previews.\n *\n * Tracks when a preloaded screen is transitioning on the native side (after\n * the preview is committed) but before React Navigation state is updated.\n * During this window, the hook synthesizes state/descriptors to keep native\n * and JS state in sync.\n */\nexport function usePreviewTransition<TNavigation extends { emit: (...args: any[]) => any }>(\n  state: StackNavigationState<ParamListBase>,\n  navigation: TNavigation,\n  descriptors: NativeStackDescriptorMap,\n  describe: DescribeFn\n) {\n  const { openPreviewKey, setOpenPreviewKey } = useLinkPreviewContext();\n\n  // Track the preview screen currently transitioning on the native side\n  const [previewTransitioningScreenId, setPreviewTransitioningScreenId] = React.useState<\n    string | undefined\n  >();\n\n  React.useEffect(() => {\n    if (previewTransitioningScreenId) {\n      // State was updated after the preview transition\n      if (state.routes.some((route) => route.key === previewTransitioningScreenId)) {\n        // No longer need to track the preview transitioning screen\n        setPreviewTransitioningScreenId(undefined);\n      }\n    }\n  }, [state, previewTransitioningScreenId]);\n\n  const navigationWrapper = React.useMemo(() => {\n    if (openPreviewKey) {\n      const emit: (typeof navigation)['emit'] = (...args) => {\n        const { target, type, data } = args[0];\n        if (target === openPreviewKey && data && 'closing' in data && !data.closing) {\n          // onWillAppear\n          if (type === 'transitionStart') {\n            // The screen from preview will appear, so we need to start tracking it\n            setPreviewTransitioningScreenId(openPreviewKey);\n          }\n          // onAppear\n          else if (type === 'transitionEnd') {\n            // The screen from preview appeared.\n            // We can now restore the stack animation\n            setOpenPreviewKey(undefined);\n          }\n        }\n        return navigation.emit(...args);\n      };\n      return {\n        ...navigation,\n        emit,\n      };\n    }\n    return navigation;\n  }, [navigation, openPreviewKey, setOpenPreviewKey]);\n\n  const { computedState, computedDescriptors } = React.useMemo(() => {\n    // The preview screen was pushed on the native side, but react-navigation state was not updated yet\n    if (previewTransitioningScreenId) {\n      const preloadedRoute = state.preloadedRoutes.find(\n        (route) => route.key === previewTransitioningScreenId\n      );\n      if (preloadedRoute) {\n        const newState = {\n          ...state,\n          // On native side the screen is already pushed, so we need to update the state\n          preloadedRoutes: state.preloadedRoutes.filter(\n            (route) => route.key !== previewTransitioningScreenId\n          ),\n          routes: [...state.routes, preloadedRoute],\n          index: state.index + 1,\n        };\n\n        const newDescriptors =\n          previewTransitioningScreenId in descriptors\n            ? descriptors\n            : {\n                ...descriptors,\n                // We need to add the descriptor. For react-navigation this is still preloaded screen\n                // Replicating the logic from https://github.com/react-navigation/react-navigation/blob/eaf1100ac7d99cb93ba11a999549dd0752809a78/packages/native-stack/src/views/NativeStackView.native.tsx#L489\n                [previewTransitioningScreenId]: describe(preloadedRoute, true),\n              };\n\n        return {\n          computedState: newState,\n          computedDescriptors: newDescriptors,\n        };\n      }\n    }\n\n    return {\n      computedState: state,\n      computedDescriptors: descriptors,\n    };\n  }, [state, previewTransitioningScreenId, describe, descriptors]);\n\n  return { computedState, computedDescriptors, navigationWrapper };\n}\n"]}