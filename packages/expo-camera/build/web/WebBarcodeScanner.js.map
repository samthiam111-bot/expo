{"version":3,"file":"WebBarcodeScanner.js","sourceRoot":"","sources":["../../src/web/WebBarcodeScanner.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BarcodeType, BarcodeScanningResult } from '../Camera.types';\n\n/**\n * Mapping from expo BarcodeType to BarcodeDetector format string.\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Barcode_Detection_API#supported_barcode_formats\n */\nconst EXPO_TO_WEB_FORMAT: Record<BarcodeType, string> = {\n  aztec: 'aztec',\n  codabar: 'codabar',\n  code39: 'code_39',\n  code93: 'code_93',\n  code128: 'code_128',\n  datamatrix: 'data_matrix',\n  ean8: 'ean_8',\n  ean13: 'ean_13',\n  itf14: 'itf',\n  pdf417: 'pdf417',\n  qr: 'qr_code',\n  upc_a: 'upc_a',\n  upc_e: 'upc_e',\n};\n\nconst WEB_TO_EXPO_FORMAT: Record<string, BarcodeType> = Object.fromEntries(\n  Object.entries(EXPO_TO_WEB_FORMAT).map(([expo, web]) => [web, expo as BarcodeType])\n);\n\nexport const ALL_BARCODE_TYPES = Object.keys(EXPO_TO_WEB_FORMAT) as BarcodeType[];\n\ntype BarcodeDetectorLike = {\n  detect(source: ImageBitmapSource): Promise<DetectedBarcodeLike[]>;\n};\n\ntype DetectedBarcodeLike = {\n  format: string;\n  rawValue: string;\n  boundingBox: DOMRectReadOnly;\n  cornerPoints: { x: number; y: number }[];\n};\n\nlet cachedDetector: BarcodeDetectorLike | null = null;\nlet cachedFormats: string[] | null = null;\n\nfunction formatsChanged(barcodeTypes: BarcodeType[]): boolean {\n  const webFormats = barcodeTypes.map((t) => EXPO_TO_WEB_FORMAT[t]).sort();\n  if (!cachedFormats) {\n    return true;\n  }\n  if (cachedFormats.length !== webFormats.length) {\n    return true;\n  }\n  return webFormats.some((f, i) => f !== cachedFormats![i]);\n}\n\nasync function getDetector(barcodeTypes: BarcodeType[]): Promise<BarcodeDetectorLike> {\n  if (cachedDetector && !formatsChanged(barcodeTypes)) {\n    return cachedDetector;\n  }\n\n  const webFormats = barcodeTypes.map((t) => EXPO_TO_WEB_FORMAT[t]);\n  cachedFormats = [...webFormats].sort();\n\n  const NativeBarcodeDetector = (globalThis as any).BarcodeDetector;\n  if (typeof NativeBarcodeDetector !== 'undefined') {\n    const detector: BarcodeDetectorLike = new NativeBarcodeDetector({ formats: webFormats });\n    cachedDetector = detector;\n    return detector;\n  }\n\n  const { BarcodeDetector } = await import('barcode-detector');\n  const detector: BarcodeDetectorLike = new BarcodeDetector({ formats: webFormats as any });\n  cachedDetector = detector;\n  return detector;\n}\n\nexport async function detect(\n  source: ImageBitmapSource,\n  barcodeTypes: BarcodeType[]\n): Promise<BarcodeScanningResult[]> {\n  const detector = await getDetector(barcodeTypes);\n  const barcodes = await detector.detect(source);\n\n  return barcodes.map((barcode) => {\n    const { x, y, width, height } = barcode.boundingBox;\n    return {\n      type: WEB_TO_EXPO_FORMAT[barcode.format] ?? barcode.format,\n      data: barcode.rawValue,\n      bounds: {\n        origin: { x, y },\n        size: { width, height },\n      },\n      cornerPoints: barcode.cornerPoints?.map((p) => ({ x: p.x, y: p.y })) ?? [],\n    };\n  });\n}\n"]}